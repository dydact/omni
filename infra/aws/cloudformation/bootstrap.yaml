AWSTemplateFormatVersion: '2010-09-09'
Description: 'Omni Bootstrap - Minimal setup for Omni deployment'

Parameters:
  ExternalId:
    Type: String
    Description: Unique external ID provided by Omni (contact support@getomni.co)
    Default: "bd6733b0-8bba-11f0-92b8-eba2aa005bb1"
    NoEcho: true
    MinLength: 32
    
  OmniAccountId:
    Type: String
    Description: Omni service provider's AWS Account ID for cross-account access (NOT your account ID)
    Default: "506279660296"
  
  CostCenter:
    Type: String
    Default: "Omni"
    Description: Cost center tag for billing and cost tracking
  
  Environment:
    Type: String
    Default: "Production"
    Description: Environment tag (Production, Staging, Development)
    AllowedValues:
      - Production
      - Staging
      - Development

Resources:
  # S3 Bucket for deployment artifacts
  OmniDeploymentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'omni-deployment-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Application
          Value: Omni
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: OmniPlatform
        - Key: Component
          Value: DeploymentBucket

  # IAM Role that Omni will assume to deploy resources
  OmniDeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: OmniDeploymentRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${OmniAccountId}:root'
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !Ref ExternalId
      Tags:
        - Key: Application
          Value: Omni
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: OmniPlatform
        - Key: Component
          Value: DeploymentRole
      Policies:
        - PolicyName: OmniDeploymentPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # S3 permissions for deployment bucket
              - Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:PutObject'
                  - 's3:ListBucket'
                Resource:
                  - !GetAtt OmniDeploymentBucket.Arn
                  - !Sub '${OmniDeploymentBucket.Arn}/*'
              
              # RDS permissions - Describe operations (no tag conditions supported)
              - Effect: Allow
                Action:
                  - 'rds:DescribeDBInstances'
                  - 'rds:DescribeDBSubnetGroups'
                  - 'rds:ListTagsForResource'
                Resource:
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:omni-*'
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:subgrp:omni-*'
              
              # RDS permissions - Create operations (require Application=Omni tag)
              - Effect: Allow
                Action:
                  - 'rds:CreateDBInstance'
                  - 'rds:CreateDBSubnetGroup'
                  - 'rds:AddTagsToResource'
                Resource:
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:omni-*'
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:subgrp:omni-*'
                Condition:
                  StringEquals:
                    'aws:RequestTag/Application': 'Omni'
              
              # RDS permissions - Modify/Delete operations (check existing tags)
              - Effect: Allow
                Action:
                  - 'rds:ModifyDBInstance'
                  - 'rds:DeleteDBInstance'
                  - 'rds:DeleteDBSubnetGroup'
                  - 'rds:RemoveTagsFromResource'
                  - 'rds:RebootDBInstance'
                  - 'rds:ModifyDBSubnetGroup'
                  - 'rds:CreateDBSnapshot'
                  - 'rds:DeleteDBSnapshot'
                Resource:
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:omni-*'
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:subgrp:omni-*'
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:snapshot:omni-*'
              
              # ElastiCache permissions - Describe operations (no tag conditions supported)
              - Effect: Allow
                Action:
                  - 'elasticache:DescribeCacheClusters'
                  - 'elasticache:DescribeCacheSubnetGroups'
                  - 'elasticache:DescribeCacheParameterGroups'
                  - 'elasticache:DescribeCacheParameters'
                  - 'elasticache:DescribeCacheEngineVersions'
                  - 'elasticache:DescribeCacheSecurityGroups'
                  - 'elasticache:DescribeReservedCacheNodes'
                  - 'elasticache:ListTagsForResource'
                Resource: '*'
              
              # ElastiCache permissions - Create operations
              - Effect: Allow
                Action:
                  - 'elasticache:CreateCacheCluster'
                  - 'elasticache:CreateCacheSubnetGroup'
                  - 'elasticache:AddTagsToResource'
                Resource:
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:cluster:omni-*'
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:subnetgroup:omni-*'
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:parametergroup:*'
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:securitygroup:*'
              
              # ElastiCache permissions - Modify/Delete operations
              - Effect: Allow
                Action:
                  - 'elasticache:ModifyCacheCluster'
                  - 'elasticache:DeleteCacheCluster'
                  - 'elasticache:DeleteCacheSubnetGroup'
                  - 'elasticache:RebootCacheCluster'
                  - 'elasticache:ModifyCacheSubnetGroup'
                  - 'elasticache:RemoveTagsFromResource'
                Resource:
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:cluster:omni-*'
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:subnetgroup:omni-*'
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:parametergroup:*'
              
              # VPC and networking - Describe operations (needed for CloudFormation resource discovery)
              - Effect: Allow
                Action:
                  - 'ec2:DescribeAvailabilityZones'
                  - 'ec2:DescribeVpcs'
                  - 'ec2:DescribeSubnets'
                  - 'ec2:DescribeSecurityGroups'
                  - 'ec2:DescribeInternetGateways'
                  - 'ec2:DescribeRouteTables'
                  - 'ec2:DescribeNatGateways'
                  - 'ec2:DescribeAddresses'
                  - 'ec2:DescribeNetworkInterfaces'
                  - 'ec2:DescribeTags'
                  - 'ec2:DescribeAccountAttributes'
                Resource: '*'
              
              # VPC and networking - Create operations (CloudFormation doesn't support tag-on-create)
              - Effect: Allow
                Action:
                  - 'ec2:CreateVpc'
                  - 'ec2:CreateSecurityGroup'
                  - 'ec2:CreateInternetGateway'
                  - 'ec2:CreateNatGateway'
                  - 'ec2:AllocateAddress'
                  - 'ec2:CreateTags'
                Resource: '*'
              
              # VPC and networking - Subnet creation (no tag condition support)
              - Effect: Allow
                Action:
                  - 'ec2:CreateSubnet'
                Resource: '*'
              
              # VPC and networking - Route table creation (no tag condition support)
              - Effect: Allow
                Action:
                  - 'ec2:CreateRouteTable'
                Resource: '*'
              
              # VPC and networking - Operations on resources we created (tagged with Application=Omni)
              - Effect: Allow
                Action:
                  - 'ec2:CreateRoute'
                  - 'ec2:DeleteRoute'
                  - 'ec2:AttachInternetGateway'
                  - 'ec2:DetachInternetGateway'
                  - 'ec2:AssociateRouteTable'
                  - 'ec2:DisassociateRouteTable'
                  - 'ec2:AuthorizeSecurityGroupIngress'
                  - 'ec2:AuthorizeSecurityGroupEgress'
                  - 'ec2:RevokeSecurityGroupIngress'
                  - 'ec2:RevokeSecurityGroupEgress'
                  - 'ec2:ModifyVpcAttribute'
                  - 'ec2:ModifySubnetAttribute'
                  - 'ec2:DeleteVpc'
                  - 'ec2:DeleteSubnet'
                  - 'ec2:DeleteSecurityGroup'
                  - 'ec2:DeleteInternetGateway'
                  - 'ec2:DeleteRouteTable'
                  - 'ec2:DeleteNatGateway'
                  - 'ec2:ReleaseAddress'
                Resource: '*'
                Condition:
                  StringEquals:
                    'ec2:ResourceTag/Application': 'Omni'
              
              # Load balancer - Describe operations (needed for CloudFormation resource discovery)
              - Effect: Allow
                Action:
                  - 'elasticloadbalancing:DescribeLoadBalancers'
                  - 'elasticloadbalancing:DescribeTargetGroups'
                  - 'elasticloadbalancing:DescribeListeners'
                  - 'elasticloadbalancing:DescribeRules'
                  - 'elasticloadbalancing:DescribeTargetHealth'
                  - 'elasticloadbalancing:DescribeTags'
                Resource: '*'
              
              # Load balancer - Create/Modify operations for omni-* resources
              - Effect: Allow
                Action:
                  - 'elasticloadbalancing:CreateLoadBalancer'
                  - 'elasticloadbalancing:CreateTargetGroup'
                  - 'elasticloadbalancing:CreateListener'
                  - 'elasticloadbalancing:CreateRule'
                  - 'elasticloadbalancing:DeleteLoadBalancer'
                  - 'elasticloadbalancing:DeleteTargetGroup'
                  - 'elasticloadbalancing:DeleteListener'
                  - 'elasticloadbalancing:DeleteRule'
                  - 'elasticloadbalancing:RegisterTargets'
                  - 'elasticloadbalancing:DeregisterTargets'
                  - 'elasticloadbalancing:ModifyLoadBalancerAttributes'
                  - 'elasticloadbalancing:ModifyTargetGroup'
                  - 'elasticloadbalancing:ModifyTargetGroupAttributes'
                  - 'elasticloadbalancing:ModifyListener'
                  - 'elasticloadbalancing:ModifyRule'
                  - 'elasticloadbalancing:AddTags'
                  - 'elasticloadbalancing:RemoveTags'
                Resource:
                  - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:loadbalancer/app/omni-*'
                  - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:targetgroup/omni-*/*'
                  - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:listener/app/omni-*/*'
                  - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:listener-rule/app/omni-*/*/*'
              
              # IAM permissions for ECS task roles
              - Effect: Allow
                Action:
                  - 'iam:CreateRole'
                  - 'iam:AttachRolePolicy'
                  - 'iam:PutRolePolicy'
                  - 'iam:PassRole'
                  - 'iam:GetRole'
                  - 'iam:GetRolePolicy'
                  - 'iam:ListRolePolicies'
                  - 'iam:ListAttachedRolePolicies'
                  - 'iam:TagRole'
                  - 'iam:UntagRole'
                  - 'iam:DeleteRole'
                  - 'iam:DeleteRolePolicy'
                  - 'iam:DetachRolePolicy'
                  - 'iam:UpdateAssumeRolePolicy'
                  - 'iam:ListRoleTags'
                Resource:
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:role/omni-*'
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:role/ecsTaskExecutionRole'
              
              # IAM permissions for service-linked roles
              - Effect: Allow
                Action:
                  - 'iam:CreateServiceLinkedRole'
                Resource: 
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.amazonaws.com/AWSServiceRoleForECS'
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:role/aws-service-role/elasticache.amazonaws.com/AWSServiceRoleForElastiCache'
                Condition:
                  StringLike:
                    'iam:AWSServiceName': 
                      - 'ecs.amazonaws.com'
                      - 'elasticache.amazonaws.com'
              
              # CloudWatch Logs permissions
              - Effect: Allow
                Action:
                  - 'logs:*'
                Resource:
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/ecs/omni-*'
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/ecs/omni-*:*'
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/omni-*'
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/omni-*:*'
              
              # Lambda permissions
              - Effect: Allow
                Action:
                  - 'lambda:*'
                Resource: !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:omni-*'
              
              # ECS cluster permissions
              - Effect: Allow
                Action:
                  - 'ecs:CreateCluster'
                  - 'ecs:DeleteCluster'
                Resource: !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:cluster/omni-*'
              
              - Effect: Allow
                Action:
                  - 'ecs:RegisterTaskDefinition'
                  - 'ecs:DeregisterTaskDefinition'
                  - 'ecs:DescribeTaskDefinition'
                  - 'ecs:ListTaskDefinitions'
                Resource: '*'
              
              
              - Effect: Allow
                Action:
                  - 'ecs:CreateService'
                  - 'ecs:UpdateService'
                  - 'ecs:DeleteService'
                  - 'ecs:RunTask'
                  - 'ecs:StopTask'
                  - 'ecs:TagResource'
                  - 'ecs:UntagResource'
                  - 'ecs:ListTagsForResource'
                Resource: 
                  - !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:cluster/omni-*'
                  - !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:service/omni-*/omni-*'
                  - !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task/omni-*/*'
                  - !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/omni-*:*'
              
              # Secrets Manager permissions
              - Effect: Allow
                Action:
                  - 'secretsmanager:*'
                Resource: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:omni/*'
              
              - Effect: Allow
                Action:
                  - 'secretsmanager:GetRandomPassword'
                Resource: '*'
              
              # KMS permissions for encrypted secrets (if using default AWS managed key)
              - Effect: Allow
                Action:
                  - 'kms:GenerateDataKey'
                  - 'kms:Decrypt'
                  - 'kms:DescribeKey'
                Resource: 
                  - !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*'
              
              
              # CloudFormation permissions for stack management
              - Effect: Allow
                Action:
                  - 'cloudformation:CreateStack'
                  - 'cloudformation:UpdateStack'
                  - 'cloudformation:DeleteStack'
                  - 'cloudformation:DescribeStacks'
                  - 'cloudformation:DescribeStackEvents'
                  - 'cloudformation:GetTemplate'
                Resource: !Sub 'arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/omni-*/*'
              
              # Service Discovery - Namespace creation (no specific resource required)
              - Effect: Allow
                Action:
                  - 'servicediscovery:CreatePrivateDnsNamespace'
                Resource: '*'
              
              # Route53 permissions for Service Discovery private DNS
              - Effect: Allow
                Action:
                  - 'route53:CreateHostedZone'
                  - 'route53:DeleteHostedZone'
                  - 'route53:GetHostedZone'
                  - 'route53:ListHostedZonesByName'
                  - 'route53:ChangeResourceRecordSets'
                  - 'route53:ListResourceRecordSets'
                Resource: '*'
              
              # Service Discovery - Namespace operations
              # WARNING: Cannot restrict to omni-* namespaces as Service Discovery uses random IDs
              # This allows operations on any namespace in the account - a known limitation
              - Effect: Allow
                Action:
                  - 'servicediscovery:DeleteNamespace'
                  - 'servicediscovery:GetNamespace'
                  - 'servicediscovery:UpdatePrivateDnsNamespace'
                Resource: !Sub 'arn:aws:servicediscovery:${AWS::Region}:${AWS::AccountId}:namespace/*'
              
              # Service Discovery - Service operations (no tag condition support)
              - Effect: Allow
                Action:
                  - 'servicediscovery:CreateService'
                  - 'servicediscovery:DeleteService'
                  - 'servicediscovery:GetService'
                  - 'servicediscovery:RegisterInstance'
                  - 'servicediscovery:DeregisterInstance'
                  - 'servicediscovery:UpdateService'
                  - 'servicediscovery:ListInstances'
                  - 'servicediscovery:GetInstance'
                Resource: 
                  - !Sub 'arn:aws:servicediscovery:${AWS::Region}:${AWS::AccountId}:service/*'
                  - !Sub 'arn:aws:servicediscovery:${AWS::Region}:${AWS::AccountId}:namespace/*'
              
              # Service Discovery - List and internal operations (don't require specific resources)
              - Effect: Allow
                Action:
                  - 'servicediscovery:ListNamespaces'
                  - 'servicediscovery:ListServices'
                  - 'servicediscovery:GetOperation'
                  - 'servicediscovery:ListOperations'
                Resource: '*'
              
              # AWS Bedrock permissions for AI functionality
              - Effect: Allow
                Action:
                  - 'bedrock:InvokeModel'
                  - 'bedrock:InvokeModelWithResponseStream'
                  - 'bedrock:GetFoundationModel'
                  - 'bedrock:ListFoundationModels'
                Resource: '*'
              
              # Monitoring and debugging permissions
              - Effect: Allow
                Action:
                  - 'ecs:ExecuteCommand'
                  - 'ecs:Describe*'
                  - 'ecs:List*'
                  - 'rds:Describe*'
                  - 'rds:DownloadDBLogFile'
                  - 'elasticache:Describe*'
                  - 'logs:Get*'
                  - 'logs:FilterLogEvents'
                  - 'logs:StartQuery'
                  - 'logs:StopQuery'
                  - 'ssm:StartSession'
                  - 'ssm:TerminateSession'
                  - 'ssm:ResumeSession'
                  - 'ssm:DescribeSessions'
                  - 'ssm:GetConnectionStatus'
                  - 'elasticloadbalancing:Describe*'
                  - 'cloudwatch:Get*'
                  - 'cloudwatch:List*'
                  - 'cloudwatch:Describe*'
                  - 'servicediscovery:DiscoverInstances'
                  - 'servicediscovery:GetInstancesHealthStatus'
                Resource: '*'
              
              # ECS Exec permissions for task roles - Allow deployment role to update task roles
              - Effect: Allow
                Action:
                  - 'iam:PutRolePolicy'
                  - 'iam:CreatePolicy'
                  - 'iam:AttachRolePolicy'
                  - 'iam:UpdateRole'
                Resource:
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:role/omni-*'
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:policy/omni-*'
              
              # SSM permissions for ECS Exec functionality
              - Effect: Allow
                Action:
                  - 'ssmmessages:CreateControlChannel'
                  - 'ssmmessages:CreateDataChannel'
                  - 'ssmmessages:OpenControlChannel'
                  - 'ssmmessages:OpenDataChannel'
                Resource: '*'

Outputs:
  DeploymentRoleArn:
    Description: ARN of the role Omni will use for deployment
    Value: !GetAtt OmniDeploymentRole.Arn
    Export:
      Name: !Sub omni-bootstrap-${AWS::StackName}-role-arn
    
  DeploymentBucket:
    Description: S3 bucket for deployment artifacts
    Value: !Ref OmniDeploymentBucket
    Export:
      Name: !Sub omni-bootstrap-${AWS::StackName}-bucket
    
  AccountId:
    Description: Your AWS Account ID (share this with Omni support)
    Value: !Ref AWS::AccountId
    
  Region:
    Description: Deployment region
    Value: !Ref AWS::Region
  
  CostTrackingTags:
    Description: Tags applied to all Omni resources for cost tracking
    Value: !Sub 'Application=Omni, CostCenter=${CostCenter}, Environment=${Environment}'
    
  NextSteps:
    Description: What to do next
    Value: |
      1. Share the AccountId and Region outputs with Omni support
      2. Omni will deploy your services within 24 hours
      3. You'll receive an email with your Omni URL and admin credentials
      4. Track costs using the CostCenter tag in AWS Cost Explorer
