AWSTemplateFormatVersion: '2010-09-09'
Description: 'Omni Bootstrap - Minimal setup for Omni deployment'

Parameters:
  ExternalId:
    Type: String
    Description: Unique external ID provided by Omni (contact support@getomni.co)
    NoEcho: true
    MinLength: 32
    
  OmniAccountId:
    Type: String
    Description: Omni service provider's AWS Account ID for cross-account access (NOT your account ID)
    Default: "REPLACE_WITH_OMNI_SERVICE_PROVIDER_ACCOUNT_ID"
  
  CostCenter:
    Type: String
    Default: "Omni"
    Description: Cost center tag for billing and cost tracking
  
  Environment:
    Type: String
    Default: "Production"
    Description: Environment tag (Production, Staging, Development)
    AllowedValues:
      - Production
      - Staging
      - Development

Resources:
  # S3 Bucket for deployment artifacts
  OmniDeploymentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'omni-deployment-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Application
          Value: Omni
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: OmniPlatform
        - Key: Component
          Value: DeploymentBucket

  # IAM Role that Omni will assume to deploy resources
  OmniDeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: OmniDeploymentRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${OmniAccountId}:root'
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !Ref ExternalId
      Tags:
        - Key: Application
          Value: Omni
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: OmniPlatform
        - Key: Component
          Value: DeploymentRole
      Policies:
        - PolicyName: OmniDeploymentPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # S3 permissions for deployment bucket
              - Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:PutObject'
                  - 's3:ListBucket'
                Resource:
                  - !GetAtt OmniDeploymentBucket.Arn
                  - !Sub '${OmniDeploymentBucket.Arn}/*'
              
              # RDS permissions - Describe operations (no tag conditions supported)
              - Effect: Allow
                Action:
                  - 'rds:DescribeDBInstances'
                  - 'rds:DescribeDBSubnetGroups'
                  - 'rds:ListTagsForResource'
                Resource:
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:omni-*'
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:subgrp:omni-*'
              
              # RDS permissions - Create operations (require Application=Omni tag)
              - Effect: Allow
                Action:
                  - 'rds:CreateDBInstance'
                  - 'rds:CreateDBSubnetGroup'
                  - 'rds:AddTagsToResource'
                Resource:
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:omni-*'
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:subgrp:omni-*'
                Condition:
                  StringEquals:
                    'aws:RequestTag/Application': 'Omni'
              
              # RDS permissions - Modify/Delete operations (check existing tags)
              - Effect: Allow
                Action:
                  - 'rds:ModifyDBInstance'
                  - 'rds:DeleteDBInstance'
                  - 'rds:RemoveTagsFromResource'
                Resource:
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:omni-*'
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:subgrp:omni-*'
              
              # ElastiCache permissions - Describe operations (no tag conditions supported)
              - Effect: Allow
                Action:
                  - 'elasticache:DescribeCacheClusters'
                  - 'elasticache:DescribeCacheSubnetGroups'
                  - 'elasticache:ListTagsForResource'
                Resource:
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:cluster:omni-*'
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:subnetgroup:omni-*'
              
              # ElastiCache permissions - Create operations (require Application=Omni tag)
              - Effect: Allow
                Action:
                  - 'elasticache:CreateCacheCluster'
                  - 'elasticache:CreateCacheSubnetGroup'
                  - 'elasticache:AddTagsToResource'
                Resource:
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:cluster:omni-*'
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:subnetgroup:omni-*'
                Condition:
                  StringEquals:
                    'aws:RequestTag/Application': 'Omni'
              
              # ElastiCache permissions - Modify/Delete operations
              - Effect: Allow
                Action:
                  - 'elasticache:ModifyCacheCluster'
                  - 'elasticache:DeleteCacheCluster'
                Resource:
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:cluster:omni-*'
                  - !Sub 'arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:subnetgroup:omni-*'
              
              # VPC and networking - Only describe AZs (no customer resources exposed)
              - Effect: Allow
                Action:
                  - 'ec2:DescribeAvailabilityZones'
                Resource: '*'
              
              # VPC and networking - Create operations with tagging requirement
              - Effect: Allow
                Action:
                  - 'ec2:CreateVpc'
                  - 'ec2:CreateSubnet'
                  - 'ec2:CreateSecurityGroup'
                  - 'ec2:CreateInternetGateway'
                  - 'ec2:CreateRouteTable'
                  - 'ec2:CreateNatGateway'
                  - 'ec2:AllocateAddress'
                  - 'ec2:CreateTags'
                Resource: '*'
                Condition:
                  StringEquals:
                    'aws:RequestTag/Application': 'Omni'
              
              # VPC and networking - Operations on resources we created (tagged with Application=Omni)
              - Effect: Allow
                Action:
                  - 'ec2:CreateRoute'
                  - 'ec2:DeleteRoute'
                  - 'ec2:AttachInternetGateway'
                  - 'ec2:DetachInternetGateway'
                  - 'ec2:AssociateRouteTable'
                  - 'ec2:DisassociateRouteTable'
                  - 'ec2:AuthorizeSecurityGroupIngress'
                  - 'ec2:AuthorizeSecurityGroupEgress'
                  - 'ec2:RevokeSecurityGroupIngress'
                  - 'ec2:RevokeSecurityGroupEgress'
                  - 'ec2:ModifyVpcAttribute'
                  - 'ec2:ModifySubnetAttribute'
                  - 'ec2:DeleteVpc'
                  - 'ec2:DeleteSubnet'
                  - 'ec2:DeleteSecurityGroup'
                  - 'ec2:DeleteInternetGateway'
                  - 'ec2:DeleteRouteTable'
                  - 'ec2:DeleteNatGateway'
                  - 'ec2:ReleaseAddress'
                  - 'ec2:DescribeVpcs'
                  - 'ec2:DescribeSubnets'
                  - 'ec2:DescribeSecurityGroups'
                  - 'ec2:DescribeInternetGateways'
                  - 'ec2:DescribeRouteTables'
                  - 'ec2:DescribeNatGateways'
                  - 'ec2:DescribeAddresses'
                  - 'ec2:DescribeNetworkInterfaces'
                Resource: '*'
                Condition:
                  StringEquals:
                    'ec2:ResourceTag/Application': 'Omni'
              
              # Load balancer - Create/Modify operations for omni-* resources
              - Effect: Allow
                Action:
                  - 'elasticloadbalancing:CreateLoadBalancer'
                  - 'elasticloadbalancing:CreateTargetGroup'
                  - 'elasticloadbalancing:CreateListener'
                  - 'elasticloadbalancing:CreateRule'
                  - 'elasticloadbalancing:DeleteLoadBalancer'
                  - 'elasticloadbalancing:DeleteTargetGroup'
                  - 'elasticloadbalancing:DeleteListener'
                  - 'elasticloadbalancing:DeleteRule'
                  - 'elasticloadbalancing:RegisterTargets'
                  - 'elasticloadbalancing:DeregisterTargets'
                  - 'elasticloadbalancing:ModifyLoadBalancerAttributes'
                  - 'elasticloadbalancing:ModifyTargetGroup'
                  - 'elasticloadbalancing:ModifyTargetGroupAttributes'
                  - 'elasticloadbalancing:ModifyListener'
                  - 'elasticloadbalancing:ModifyRule'
                  - 'elasticloadbalancing:AddTags'
                  - 'elasticloadbalancing:RemoveTags'
                  - 'elasticloadbalancing:DescribeLoadBalancers'
                  - 'elasticloadbalancing:DescribeTargetGroups'
                  - 'elasticloadbalancing:DescribeListeners'
                  - 'elasticloadbalancing:DescribeRules'
                  - 'elasticloadbalancing:DescribeTargetHealth'
                  - 'elasticloadbalancing:DescribeTags'
                Resource:
                  - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:loadbalancer/app/omni-*'
                  - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:targetgroup/omni-*/*'
                  - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:listener/app/omni-*/*'
                  - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:listener-rule/app/omni-*/*/*'
              
              # IAM permissions for ECS task roles
              - Effect: Allow
                Action:
                  - 'iam:CreateRole'
                  - 'iam:AttachRolePolicy'
                  - 'iam:PutRolePolicy'
                  - 'iam:PassRole'
                  - 'iam:GetRole'
                  - 'iam:ListRolePolicies'
                  - 'iam:ListAttachedRolePolicies'
                Resource:
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:role/omni-*'
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:role/ecsTaskExecutionRole'
              
              # CloudWatch Logs permissions - only for Omni log groups
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                  - 'logs:DescribeLogGroups'
                  - 'logs:DescribeLogStreams'
                  - 'logs:DeleteLogGroup'
                  - 'logs:DeleteLogStream'
                  - 'logs:PutRetentionPolicy'
                  - 'logs:TagLogGroup'
                Resource:
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/ecs/omni-*'
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/ecs/omni-*:*'
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/omni-*'
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/omni-*:*'
              
              # Lambda permissions for migrator function
              - Effect: Allow
                Action:
                  - 'lambda:CreateFunction'
                  - 'lambda:UpdateFunctionCode'
                  - 'lambda:UpdateFunctionConfiguration'
                  - 'lambda:DeleteFunction'
                  - 'lambda:GetFunction'
                  - 'lambda:InvokeFunction'
                  - 'lambda:TagResource'
                  - 'lambda:AddPermission'
                  - 'lambda:RemovePermission'
                Resource: !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:omni-*'
              
              # ECS permissions for Fargate deployments
              - Effect: Allow
                Action:
                  - 'ecs:CreateCluster'
                  - 'ecs:DeleteCluster'
                  - 'ecs:DescribeClusters'
                  - 'ecs:TagResource'
                Resource: !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:cluster/omni-*'
              
              - Effect: Allow
                Action:
                  - 'ecs:RegisterTaskDefinition'
                  - 'ecs:DeregisterTaskDefinition'
                  - 'ecs:DescribeTaskDefinition'
                  - 'ecs:ListTaskDefinitions'
                Resource: '*'
              
              - Effect: Allow
                Action:
                  - 'ecs:CreateService'
                  - 'ecs:UpdateService'
                  - 'ecs:DeleteService'
                  - 'ecs:DescribeServices'
                  - 'ecs:TagResource'
                Resource: !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:service/omni-*/omni-*'
              
              - Effect: Allow
                Action:
                  - 'ecs:RunTask'
                  - 'ecs:StopTask'
                  - 'ecs:DescribeTasks'
                  - 'ecs:ListTasks'
                Resource:
                  - !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task/omni-*/*'
                  - !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/omni-*:*'
              
              # Secrets Manager permissions
              - Effect: Allow
                Action:
                  - 'secretsmanager:CreateSecret'
                  - 'secretsmanager:GetSecretValue'
                  - 'secretsmanager:UpdateSecret'
                  - 'secretsmanager:DeleteSecret'
                  - 'secretsmanager:DescribeSecret'
                  - 'secretsmanager:TagResource'
                Resource: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:omni/*'
              
              # Tagging permissions for all resources
              - Effect: Allow
                Action:
                  - 'tag:TagResources'
                  - 'tag:UntagResources'
                  - 'tag:GetResources'
                  - 'tag:GetTagKeys'
                  - 'tag:GetTagValues'
                Resource: '*'
              
              # CloudFormation permissions for stack management
              - Effect: Allow
                Action:
                  - 'cloudformation:CreateStack'
                  - 'cloudformation:UpdateStack'
                  - 'cloudformation:DeleteStack'
                  - 'cloudformation:DescribeStacks'
                  - 'cloudformation:DescribeStackEvents'
                  - 'cloudformation:GetTemplate'
                Resource: !Sub 'arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/omni-*/*'
              
              # Service Discovery - Namespace operations (require namespace resource)
              - Effect: Allow
                Action:
                  - 'servicediscovery:CreatePrivateDnsNamespace'
                  - 'servicediscovery:DeleteNamespace'
                  - 'servicediscovery:GetNamespace'
                  - 'servicediscovery:UpdatePrivateDnsNamespace'
                Resource: !Sub 'arn:aws:servicediscovery:${AWS::Region}:${AWS::AccountId}:namespace/*'
                Condition:
                  StringEquals:
                    'aws:RequestTag/Application': 'Omni'
              
              # Service Discovery - Service operations (require service resource)
              - Effect: Allow
                Action:
                  - 'servicediscovery:CreateService'
                  - 'servicediscovery:DeleteService'
                  - 'servicediscovery:GetService'
                  - 'servicediscovery:RegisterInstance'
                  - 'servicediscovery:DeregisterInstance'
                  - 'servicediscovery:UpdateService'
                Resource: !Sub 'arn:aws:servicediscovery:${AWS::Region}:${AWS::AccountId}:service/*'
                Condition:
                  StringEquals:
                    'aws:RequestTag/Application': 'Omni'
              
              # Service Discovery - List operations (don't require specific resources)
              - Effect: Allow
                Action:
                  - 'servicediscovery:ListNamespaces'
                  - 'servicediscovery:ListServices'
                Resource: '*'
              
              # AWS Bedrock permissions for AI functionality
              - Effect: Allow
                Action:
                  - 'bedrock:InvokeModel'
                  - 'bedrock:InvokeModelWithResponseStream'
                  - 'bedrock:GetFoundationModel'
                  - 'bedrock:ListFoundationModels'
                Resource: '*'

Outputs:
  DeploymentRoleArn:
    Description: ARN of the role Omni will use for deployment
    Value: !GetAtt OmniDeploymentRole.Arn
    Export:
      Name: !Sub omni-bootstrap-${AWS::StackName}-role-arn
    
  DeploymentBucket:
    Description: S3 bucket for deployment artifacts
    Value: !Ref OmniDeploymentBucket
    Export:
      Name: !Sub omni-bootstrap-${AWS::StackName}-bucket
    
  AccountId:
    Description: Your AWS Account ID (share this with Omni support)
    Value: !Ref AWS::AccountId
    
  Region:
    Description: Deployment region
    Value: !Ref AWS::Region
  
  CostTrackingTags:
    Description: Tags applied to all Omni resources for cost tracking
    Value: !Sub 'Application=Omni, CostCenter=${CostCenter}, Environment=${Environment}'
    
  NextSteps:
    Description: What to do next
    Value: |
      1. Share the AccountId and Region outputs with Omni support
      2. Omni will deploy your services within 24 hours
      3. You'll receive an email with your Omni URL and admin credentials
      4. Track costs using the CostCenter tag in AWS Cost Explorer
